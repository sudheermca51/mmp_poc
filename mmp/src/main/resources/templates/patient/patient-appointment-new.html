<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <title>New Appointment</title>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <link rel="stylesheet" th:href="@{/css/app.css}">

  <style>
    /* style for flatpickr visible input */
    .flatpickr-input[readonly]{
      background:#fff;
      cursor:pointer;
      width:100%;
      padding:8px;
      border-radius:6px;
      border:1px solid #d1d5db;
      box-sizing:border-box;
    }

    .doctor-card.selected {
      outline: 3px solid rgba(59,130,246,0.18);
      box-shadow: 0 12px 40px rgba(14,165,233,0.06);
    }
    .doctor-card .selected-badge { display:none; }
    .doctor-card.selected .selected-badge { display:block; }
  </style>
</head>

<body>
<div class="layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">MMP</div>
      <div class="subtitle">Patient Portal</div>
    </div>

    <nav class="sidebar-nav">
      <a th:classappend="${activeMenu}=='home' ? ' active' : ''" th:href="@{/patient/home}">
        <span>Home</span>
      </a>

      <a th:classappend="${activeMenu}=='profile' ? ' active' : ''" href="#" onclick="alert('Profile placeholder'); return false;">
        <span>Profile</span>
      </a>

      <a th:classappend="${activeMenu}=='schedule' ? ' active' : ''" th:href="@{/patient/appointments/new}">
        <span>Schedule Appointment</span>
      </a>

      <a th:classappend="${activeMenu}=='info' ? ' active' : ''" href="#" onclick="alert('Information placeholder'); return false;">
        <span>Information</span>
      </a>

      <a th:classappend="${activeMenu}=='fees' ? ' active' : ''" th:href="@{/patient/fees}">
        <span>Fees</span>
      </a>

      <a th:classappend="${activeMenu}=='reports' ? ' active' : ''" th:href="@{/patient/reports}">
        <span>Reports</span>
      </a>

      <a th:classappend="${activeMenu}=='messages' ? ' active' : ''" th:href="@{/patient/messages}">
        <span>Messages</span>
      </a>

      <a th:classappend="${activeMenu}=='logout' ? ' active' : ''" th:href="@{/patient/logout}">
        <span>Logout</span>
      </a>
    </nav>

    <div class="sidebar-footer">Training build - Patient view</div>
  </aside>

  <!-- Main area -->
  <main class="layout-main">
    <div class="card">
      <h3>Schedule Appointment</h3>

      <form method="post" th:action="@{/patient/appointments/new}">

        <label>Choose Doctor</label>

        <!-- hidden doctor input -->
        <input type="hidden" name="doctorId" id="doctorId">

        <div class="doctor-grid" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:8px;">
          <div th:each="d : ${doctors}"
               class="doctor-card"
               th:attr="data-doctor-id=${d.id}"
               style="border:1px solid #e5e7eb; padding:12px; border-radius:10px; width:200px; cursor:pointer;
                      background:#fff; box-shadow:0 6px 16px rgba(15,23,42,0.04); text-align:center;">

            <img th:src="@{'/images/doctors/' + ${d.photoPath}}"
                 alt="Doctor"
                 style="width:70px;height:70px;border-radius:50%;object-fit:cover;margin-bottom:10px;"
                 onerror="this.src='/images/default-doctor.png';"/>

            <div style="font-weight:700; margin-bottom:4px;" th:text="${d.name}">Doctor Name</div>
            <div style="font-size:13px; color:#6b7280;" th:text="${d.specialization}">Specialization</div>

            <div class="selected-badge" style="margin-top:8px; font-size:13px; color:#065f46;">
              Selected âœ“
            </div>
          </div>
        </div>

        <br>

        <label>Date</label>
        <input id="dateInput" name="date" type="text"
               placeholder="Select date"
               autocomplete="off"
               style="width:100%; padding:8px; border-radius:6px; border:1px solid #d1d5db; margin-top:6px;" />

        <br><br>

        <label>Reason</label>
        <input type="text" name="reason" required
               style="width:100%; padding:8px; border-radius:6px; border:1px solid #d1d5db; margin-top:6px;" />

        <div style="margin-top:12px;">
          <button class="btn-primary" type="submit">Create</button>
          <a th:href="@{/patient/home}" class="btn-ghost" style="margin-left:8px;">Cancel</a>
        </div>

      </form>
    </div>
  </main>

</div>

<!-- FINAL CLEAN WORKING SCRIPT -->
<script>
(function(){

  function $id(id){ return document.getElementById(id); }

  /* -------------------------
     Doctor card selection
  ------------------------- */
  document.addEventListener('click', function(evt){
    const card = evt.target.closest && evt.target.closest('.doctor-card');
    if(!card) return;

    document.querySelectorAll('.doctor-card.selected')
            .forEach(c => c.classList.remove('selected'));

    card.classList.add('selected');

    const did = card.getAttribute('data-doctor-id');
    const hid = $id('doctorId');
    if(hid) hid.value = did || '';

    const dt = $id('dateInput');
    if(dt) dt.focus();
  });

  /* -------------------------
     Flatpickr Date Only
  ------------------------- */
  function initDatePicker(){
    const el = $id('dateInput');
    if(!el) return;

    if(window.flatpickr){
      flatpickr(el, {
        enableTime: false,
        dateFormat: "Y-m-d",     // backend-friendly value
        altInput: true,
        altFormat: "F j, Y",     // user-friendly format
        disableMobile: true,
        minDate: "today",
        allowInput: false
      });

    } else {
      // fallback to native date input
      el.type = "date";
      el.min = new Date().toISOString().slice(0,10);
    }
  }

  /* -------------------------
     Submit Validation
  ------------------------- */
  function attachSubmitGuard(){
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e){

      if(!$id('doctorId').value){
        e.preventDefault();
        alert("Please select a doctor.");
        return false;
      }

      if(!$id('dateInput').value && !$id('dateInput')._flatpickr){
        e.preventDefault();
        alert("Please select a date.");
        return false;
      }
    });
  }

  /* -------------------------
     Initialize
  ------------------------- */
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      initDatePicker();
      attachSubmitGuard();
    });
  } else {
    initDatePicker();
    attachSubmitGuard();
  }

})();
</script>

</body>
</html>
